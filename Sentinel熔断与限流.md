#1. Hystrix与Sentinel
   Hystrix存在的问题
   ```text
       1. 需要我们自己手工搭建监控平台，如之前搭建的9001模块
       2. 没有一套web界面可以给我们进行更加细粒度的配置流控，速率控制，服务熔断，服务降级...
   ```
   Sentinel
   ```text
       1. 单独一个组件，可以独立出来，
       2. 直接界面化的细粒度统一配置
   ```

 ##1.1 Sentinel是什么
  
   随着微服务的流行，服务和服务之间的稳定性变得越来越重要。Sentinel 以流量为切入点，从流量控制、熔断降级、系统负载保护等多个维度保护服务的稳定性。
 
   Sentinel 具有以下特征:
   ```text
       - 丰富的应用场景：Sentinel 承接了阿里巴巴近 10 年的双十一大促流量的核心场景，例如秒杀（即突发流量控制在系统容量可以承受的范围）、消息削峰填谷、集群流量控制、实时熔断下游不可用应用等。
       - 完备的实时监控：Sentinel 同时提供实时的监控功能。您可以在控制台中看到接入应用的单台机器秒级数据，甚至 500 台以下规模的集群的汇总运行情况。
       - 广泛的开源生态：Sentinel 提供开箱即用的与其它开源框架/库的整合模块，例如与 Spring Cloud、Apache Dubbo、gRPC、Quarkus 的整合。您只需要引入相应的依赖并进行简单的配置即可快速地接入 Sentinel。同时 Sentinel 提供 Java/Go/C++ 等多语言的原生实现。
       - 完善的 SPI 扩展机制：Sentinel 提供简单易用、完善的 SPI 扩展接口。您可以通过实现扩展接口来快速地定制逻辑。例如定制规则管理、适配动态数据源等。
   ```
   **一句话解释，就是我们之前讲的Hystrix**
 
 ##1.2 官网下载
    https://github.com/alibaba/Sentinel
    下载下来的是一个jar包，之后执行java -jar命令成功启动，访问loclhost:8080进行访问
   
  Sentinel分为两个部分：
    ·后台
    ·前台8080
  ```text
    ·核心库(Java客户端）不依赖任何框架/库，能够运行于所有Java运行时环境，同时对Dubbo /Spring Cloud等框架也有较好的支持。
    ·控制台(Dashboard)基于Spring Boot开发，打包后可以直接运行，不需要额外的Tomcat等应用容器。
  ```

#2. 初始化演示工程
    1. 启动Nacos8848成功
    2. cloudalibaba-sentinel-service8401模块
    3. 启动Sentinel8080 java -jar 
    4. 启动微服务8401
    5. 启动8401微服务后查看Sentinel控制台，发现空空如也，因为Sentinel采用的是懒加载机制，执行一次访问后便可以显示(http://localhost:8401/testA)
    
#3. 流控规则
 ##3.1 基本介绍
     - 资源名：唯一名称，默认请求路径
     - 针对来源：sentinel可以针对调用者进行限流，填写微服务名，默认default（不区分来源）
     - 阈值类型/单机值：
     - QPS（每秒钟的请求数量）：当调用该api就QPS达到阈值的时候，进行限流
     - 线程数．当调用该api的线程数达到阈值的时候，进行限流
     - 是否集群：不需要集群
     - 流控模式：
     - 直接：api达到限流条件时，直接限流。分为QPS和线程数
     - 关联：当关联的资到阈值时，就限流自己。别人惹事，自己买单
     - 链路：只记录指定链路上的流量（指定资源从入口资源进来的流量，如果达到阈值，就进行限流）【api级别的针对来源】
       流控效果：
     - 快速失败：直接抛异常
     - warm up：根据codeFactor（冷加载因子，默认3）的值，从阈值codeFactor，经过预热时长，才达到设置的QPS阈值
     - 排队等待：匀速排队，请求以匀速的速度通过，阈值类型必须设置为QPS，否则无效

 ##3.2 流控模式

 ###3.2.1 直接-->快速失败(默认)
    若选择QPS并赋值1，表示1秒钟查询一次就是OK，若超过次数1,就直接快速-失败，报默认错误--Blocked by Sentinel (flow limiting)
    思考：报错后直接调用默认的报错信息，技术方面ok，但是是否应该有我们自己的后续处理？ 类似应该有一个Hystrix兜底的fallback方法
 ###3.2.2 关联
    是什么：当关联的资源达到阈值时，就限流自己，当与A关联的资源B达到阈值后，就限流A自己，B惹事，A挂了(当支付接口达到阈值后，就限流下订单的接口)
    postman模拟并发密集访问testB
    同时在浏览器中访问testA,发现A挂了。
 ###3.2.3 链路
 
 ##3.3 流控效果
 ###3.3.1 直接-->快速失败(默认的流控处理)
    直接异常，爆出错误Blocked by Sentinel (flow limiting)
 ###3.3.2 预热warm up
    公式：阈值除以coldFactor(默认为3),经过预热时长后才会达到阈值，即请求QPS从阈值/3开始，经预热时长逐渐升至设定的QPS阈值
    案例：阈值为10+预热时长设置5秒
       系统初始化的阈值为10/3约等于3，及单机阈值开始时为3，然后过了5秒钟阈值才慢慢升高恢复到10
    应用：秒杀系统在开启的瞬间，会有很多流量上来，很可能把系统打死，预热方式就是为了保护系统，可慢慢的把流量放进来，慢慢的把阈值增长到设置的阈值。 
 ###3.3.3 排队等待
    设置含义：/testA每秒1次请求，超过的话就排队等待，等待的时间为20000毫秒。


#4. 降级规则
   - RT(平均响应时间，秒级)
       平均响应时间超出阈值且在时间窗口内通过的请求>=5，两个条件同时满足后触发降级，窗口期过后关闭断路器
       RT最大4900ms(更大的需要通过-Dcsp.sentinel.statistic.max.rt=XXXX才能生效)
   - 异常比列(秒级)
       QPS>=5且异常比例(秒级统计)超过阈值时，触发降级；时间窗口结束后，关闭降级 
   - 异常数(分钟级)
       异常数( DEGRADE_GRADE_EXCEPTION_CoUNT ):当资源近1分钟的异常数目超过阈值之后会进行熔断。
       注意由于统计时间窗口是分钟级别的，若timeWindow小于60s，则结束熔断状态后可能再进入熔断状态。时间窗口一定要大于60秒。
       异常数(分钟统计)超过阈值时，触发降级，时间窗口结束后，关闭降级。
   Sentinel 熔断降级会在调用链路中某个资源出现不稳定状态时（例如调用超时或异常比例升高)，对这个资源的调用进行限制让请求快速失败，避免影响到其它的资源而导致级联错误。
   当资源被降级后，在接下来的降级时间窗口之内，对该资源的调用都自动熔断(默认行为是抛出 DegradeException).
   Sentinel的断路器没有半开状态。
   半开状态系统会自动去检测是否请求有异常，没有异常就关闭断路器恢复使用，有异常则继续打开断路器不可用，

#5. 热点Key限流(重点)
    何为热点?热点即经常访问的数据。很多时候我们希望统计某个热点数据中访问频次最高的TopK数据，并对其访问进行限制。比如:
      ·商品ID为参数，统计一段时间内最常购买的商品ID并进行限制
      ·用户ID为参数，针对一段时间内频繁访问的用户ID进行限制
    热点参数限流会统计传入参数中的热点参数，并根据配置的限流阈值与模式，对包含热点参数的资源调用进行限流。
    热点参数限流可以看做是一种特殊的流量控制，仅对包含热点参数的资源调用生效。
    Sentinel利用LRU策略统计最近最常访问的热点参数，结合令牌桶算法来进行参数级别的流控。热点参数限流支持集群模式。
 ##5.1 承上启下复习
    兜底方法
      分为系统默认和客户自定义，两种
    之前的case，限流出问题后，都是用sentinel系统默认的提示: Blocked by Sentinel (flow limiting)
    我们能不能自定?类似hystrix，某个方法出问题了，就找对应的兜底降级方法?
    结论
    从HystrixCommand到@SentinelResource
    
   @SentinelResource(value = "testHotKey", blockHandler = "deal_testHotKey")
   - value 唯一资源标志，"热点规则"配置的"资源名"
   - blockHandler 兜底方法
   
   有这样一种情况，如果不定义兜底方法，异常会直接打到前台页面，对用户不友好，
   定义了兜底方法，只要定义的热点参数QPS超过每秒1次,就马上降级处理，使用我们自定义的兜底方法。
 ##5.2 参数例外项
    上述案例演示了第一个参数p1，当QPS超过1秒1次点击后马上被限流，
    特例情况：
       普通：超过1秒钟1个后，达到阈值1后马上被限流  http://localhost:8401/testHotKey?p1=1  阈值为1
            我们期望p1参数当他是某个特殊阈值时，他的限流和平时不一样
       特例：假如当p1的值等于5时，他的阈值可以达到200  http://localhost:8401/testHotKey?p1=5  阈值为200
       前提是热点参数必须是基本类型或String
    注意：
    @SentinelResource
    处理的是sentinel控制台配置的违规情况，由blockHandler方法配置的兜底处理;
    RuntimeException
    int age = 10/0,这个是java运行时报出的运行时异常RunTimeException,@SentinelResource不管
    总结
    @SentinelResource主管配置出错，运行出错该走异常走异常
   